openapi: '3.0.3'
info:
  title: DB Data API (RDS Data API-like)
  version: '1.0'
servers:
  - url: http://localhost:8080

paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /v1/rdb/execute:
    post:
      summary: Execute SQL (with optional transaction)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExecuteRequest"
      responses:
        "200":
          description: result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecuteResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "408":
          $ref: "#/components/responses/Error408"
        "409":
          $ref: "#/components/responses/Error409"
        "410":
          $ref: "#/components/responses/Error410"
        "429":
          $ref: "#/components/responses/Error429"
        "503":
          $ref: "#/components/responses/Error503"

  /v1/rdb/tx/begin:
    post:
      summary: Begin transaction (returns txId)
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BeginTxRequest"
      responses:
        "200":
          description: tx started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BeginTxResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "429":
          $ref: "#/components/responses/Error429"
        "503":
          $ref: "#/components/responses/Error503"

  /v1/rdb/tx/commit:
    post:
      summary: Commit transaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TxIdRequest"
      responses:
        "200":
          description: committed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OkResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"
        "410":
          $ref: "#/components/responses/Error410"

  /v1/rdb/tx/rollback:
    post:
      summary: Rollback transaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TxIdRequest"
      responses:
        "200":
          description: rolled back
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OkResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"
        "410":
          $ref: "#/components/responses/Error410"

components:
  responses:
    Error400:
      description: bad request
      content: { application/json: { schema: { $ref: "#/components/schemas/ErrorResponse" } } }
    Error401:
      description: unauthorized
      content: { application/json: { schema: { $ref: "#/components/schemas/ErrorResponse" } } }
    Error403:
      description: forbidden
      content: { application/json: { schema: { $ref: "#/components/schemas/ErrorResponse" } } }
    Error408:
      description: timeout
      content: { application/json: { schema: { $ref: "#/components/schemas/ErrorResponse" } } }
    Error409:
      description: conflict
      content: { application/json: { schema: { $ref: "#/components/schemas/ErrorResponse" } } }
    Error410:
      description: gone
      content: { application/json: { schema: { $ref: "#/components/schemas/ErrorResponse" } } }
    Error429:
      description: rate limited
      content: { application/json: { schema: { $ref: "#/components/schemas/ErrorResponse" } } }
    Error503:
      description: service unavailable
      content: { application/json: { schema: { $ref: "#/components/schemas/ErrorResponse" } } }

  schemas:
    BeginTxRequest:
      type: object
      required: [datasourceId]
      additionalProperties: false
      properties:
        datasourceId:
          type: string
          description: datasource name (e.g. main)
          default: main
        timeoutMs:
          type: integer
          minimum: 1
          default: 30000

    BeginTxResponse:
      type: object
      required: [txId, apiNodeId, datasourceId, timeoutMs]
      properties:
        txId: { type: string }
        apiNodeId: { type: string }
        datasourceId: { type: string }
        timeoutMs: { type: integer }

    TxIdRequest:
      type: object
      required: [txId]
      properties:
        txId: { type: string }

    ExecuteRequest:
      type: object
      required: [sql]
      additionalProperties: false
      properties:
        sql:
          type: string
          minLength: 1
        params:
          type: array
          default: []
          items:
            $ref: "#/components/schemas/ParamValue"
        txId:
          type: string
          description: optional transaction id
        timeoutMs:
          type: integer
        datasourceId:
          type: string
        limitRows:
          type: integer
          default: 1000

    ParamValue:
      type: object
      required: [type]
      additionalProperties: false
      properties:
        type:
          type: string
          enum:
            - null
            - int32
            - int64
            - float64
            - bool
            - text
            - bytes_base64
            - timestamp_rfc3339
        value:
          description: value for the specified type
      oneOf:
        - properties: { type: { enum: [null] }, value: { type: "null" } }
        - properties: { type: { enum: [int32] }, value: { type: "integer" } }
        - properties: { type: { enum: [int64] }, value: { type: "number" } }
        - properties: { type: { enum: [float64] }, value: { type: "number" } }
        - properties: { type: { enum: [bool] }, value: { type: "boolean" } }
        - properties: { type: { enum: [text] }, value: { type: "string" } }
        - properties: { type: { enum: [bytes_base64] }, value: { type: "string" } }
        - properties: { type: { enum: [timestamp_rfc3339] }, value: { type: "string", format: "date-time" } }

    ExecuteResponse:
      type: object
      required: [meta, rows]
      properties:
        meta:
          $ref: "#/components/schemas/ResultMeta"
        rows:
          type: array
          items:
            type: object
            additionalProperties: true

    ResultMeta:
      type: object
      required: [totalCount]
      properties:
        totalCount: { type: integer }
        columns:
          type: array
          items:
            $ref: "#/components/schemas/ColumnMeta"

    ColumnMeta:
      type: object
      required: [name, dbType]
      properties:
        name: { type: string }
        dbType: { type: string }
        nullable: { type: boolean }

    HealthResponse:
      type: object
      required: [apiNodeId, apiNodePort, status, time, datasources]
      properties:
        apiNodeId: { type: string }
        apiNodePort: { type: integer }
        status: { type: string }
        time: { type: string, format: date-time }
        datasources:
          type: array
          items:
            type: object
            required: [datasourceId, status]
            properties:
              datasourceId: { type: string }
              active: { type: boolean }
              latencyMs: { type: integer }
              readonly: { type: boolean }
              maxOpenConns: { type: integer }
              maxTxConns: { type: integer }
              currentActiveConns: { type: integer }
              currentActiveTxConns: { type: integer }

    OkResponse:
      type: object
      required: [ok]
      properties:
        ok: { type: boolean }

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code: { type: string }
            message: { type: string }
            details:
              type: object
              additionalProperties: true
